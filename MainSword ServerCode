--[[
THIS SCRIPT IS ENTIRELY CODED BY "LegendOf_Omer" AKA "moredeha"
-You can read the comments to understand what does what.
-Ä°f you want to change the stats go to the "Configuration" moduleScript.
]]--

local ReplicatedStorage = game:GetService("ReplicatedStorage")
local runService = game:GetService("RunService")
local Players = game:GetService("Players")
local ContentProvider = game:GetService("ContentProvider")
local Config = require(script:WaitForChild("Configuration"))

local equippedRemote = script.Parent.Parent.Remotes["Equip/Unequip"]
local slashRemote = script.Parent.Parent.Remotes.Slash
local blockRemote = script.Parent.Parent.Remotes.Block
local specialRemote = script.Parent.Parent.Remotes.Special

local ClassicSword = script:FindFirstAncestor("ClassicSword")
local HitBox = ClassicSword:WaitForChild("HitBox")

local isEquipped = false
local isEquiping = false

local isSlashing = false
local alreadyHit = false
local comboOrder = 1

local isRunning = false

local isClientBlocking = false
local blockCooldown = false

local specialOngoing = false
local specialCooldown = false

--PreLoad animations for starting
task.spawn(function()
	local character = ClassicSword.Parent
	if not character then return end

	local humanoid = character:WaitForChild("Humanoid")

	local animsFolder = script:WaitForChild("Animations")

	local toPreload = {
		animsFolder:WaitForChild("EquipAnim"),
		animsFolder:WaitForChild("hit1"),
		animsFolder:WaitForChild("hit2"),
		animsFolder:WaitForChild("hit3"),
		animsFolder:WaitForChild("blockStart"),
		animsFolder:WaitForChild("blockIdle"),
		animsFolder:WaitForChild("blockEnd"),
		animsFolder:WaitForChild("special")
	}

	-- Preload before playing anything
	ContentProvider:PreloadAsync(toPreload)

	-- Force-load using speed=0 trick
	for _, anim in ipairs(toPreload) do
		local track = humanoid:LoadAnimation(anim)
		track:Play()
		track:Stop()
	end
end)

--Equip/Unequip
equippedRemote.OnServerEvent:Connect(function(player)
	local character = player.Character
	if not character then return end
	local humanoid = character:WaitForChild("Humanoid")
	local hrp = character:WaitForChild("HumanoidRootPart")
	local rightHand = character:WaitForChild("Right Arm")
	
	-- UNEQUIP: attach sword to hip/back
	if isEquipped and not isEquiping and not isSlashing and not isRunning and not isClientBlocking and not specialOngoing then
		local handJoint = rightHand:FindFirstChild("UnSheathJoint")
		if handJoint then handJoint:Destroy() end

		local sheathJoint = Instance.new("Motor6D")
		sheathJoint.Name = "SheathJoint"
		sheathJoint.Part0 = hrp
		sheathJoint.Part1 = ClassicSword.PrimaryPart
		sheathJoint.C0 = CFrame.new(-1, -1.2, 0) * CFrame.Angles(math.rad(20), 0, math.rad(90))
		sheathJoint.Parent = hrp
		
		comboOrder = 1
		isEquipped = false
		
	-- EQUIP: attach sword to hand
	elseif isEquiping == false and isEquipped == false then
		local sheathJoint = hrp:FindFirstChild("SheathJoint")
		if sheathJoint then sheathJoint:Destroy() end

		local handJoint = Instance.new("Motor6D")
		handJoint.Name = "UnSheathJoint"
		handJoint.Part0 = rightHand
		handJoint.Part1 = ClassicSword.PrimaryPart
		handJoint.C0 = CFrame.new(0, -1, -1.3) * CFrame.Angles(math.rad(180), 0, math.rad(90))
		handJoint.Parent = rightHand

		-- Play equip animation
		--PLAY SOUND HERE--
		local equipAnim = script.Animations:WaitForChild("EquipAnim")
		local equipTrack = humanoid:LoadAnimation(equipAnim)
		equipTrack:Play()
		isEquiping = true
		equipTrack.Stopped:wait()
		isEquiping = false
		isEquipped = true
	end
end)

--Slashing
slashRemote.OnServerEvent:Connect(function(player)
	local character = player.Character
	if not character then return end
	local humanoid = character:WaitForChild("Humanoid")
	if not humanoid then return end
	local hit1anim = script.Animations:WaitForChild("hit1")
	local hit2anim = script.Animations:WaitForChild("hit2")
	local hit3anim = script.Animations:WaitForChild("hit3")
	
	local hit1track = humanoid:LoadAnimation(hit1anim)
	local hit2track = humanoid:LoadAnimation(hit2anim)
	local hit3track = humanoid:LoadAnimation(hit3anim)
	
	if isEquipped and not isEquiping and not isSlashing and not isRunning and not isClientBlocking and not specialOngoing then
		if comboOrder == 1 then
			alreadyHit = false
			hit1track:Play()
			hit2track:Stop()
			hit3track:Stop()
			--PLAY SOUND--
			isSlashing = true
			task.delay(Config.SlashCooldown, function()
				isSlashing = false
				comboOrder = 2
			end)
		elseif comboOrder == 2 then
			alreadyHit = false
			hit2track:Play()
			hit1track:Stop()
			hit3track:Stop()
			--PLAY SOUND--
			isSlashing = true
			task.delay(Config.SlashCooldown, function()
				isSlashing = false
				comboOrder = 3
			end)
		elseif comboOrder == 3 then
			alreadyHit = false
			hit3track:Play()
			hit1track:Stop()
			hit2track:Stop()
			--PLAY SOUND--
			isSlashing = true
			task.delay(Config.SlashCooldown, function()
				isSlashing = false
				comboOrder = 1
			end)
		end
	end
end)

--Damaging
HitBox.Touched:Connect(function(target)
	local humanoid = target.Parent:FindFirstChild("Humanoid")
	if not humanoid then return end
	local player = Players:GetPlayerFromCharacter(target.Parent)
	if not player and not alreadyHit and isSlashing then
		--PLAY SOUND--
		humanoid:TakeDamage(Config.Damage)
		alreadyHit = true
	elseif player and isSlashing then
		--PLAY SOUND--
		local boolFolder = player:FindFirstChild("Bool's")
		local isBlocking = boolFolder:FindFirstChild("isBlocking")
		if isBlocking and not alreadyHit then
			humanoid:TakeDamage(Config.BlockDamage)
			alreadyHit = true
		elseif not isBlocking and not alreadyHit then
			humanoid:TakeDamage(Config.Damage)
			alreadyHit = true
		end
	end
end)

local character = ClassicSword.Parent
local humanoid = character:WaitForChild("Humanoid")
local blockStartAnim = script.Animations:WaitForChild("blockStart")
local blockIdleAnim = script.Animations:WaitForChild("blockIdle")
local blockEndAnim = script.Animations:WaitForChild("blockEnd")

local blockStartTrack = humanoid:LoadAnimation(blockStartAnim)
local blockIdleTrack = humanoid:LoadAnimation(blockIdleAnim)
local blockEndTrack = humanoid:LoadAnimation(blockEndAnim)

--Blocking
blockRemote.OnServerEvent:Connect(function(player, status)
	local boolsFolder = player:WaitForChild("Bool's")
	if not boolsFolder then print("couldnt find folder") return end
	local blockBool = boolsFolder:WaitForChild("isBlocking")
	if not blockBool then print("couldnt find bool") return end
	local character = player.Character
	if not character then print("couldnt find character") return end
	local humanoid = character:WaitForChild("Humanoid")
	if not humanoid then print("couldnt find humanoid") return end
	
	--Start Blocking
	if status == true and not isRunning and not isSlashing and not isClientBlocking and not isEquiping and isEquipped and blockBool.Value == false and blockCooldown == false and not specialOngoing then
		blockCooldown = true
		task.delay(Config.BlockCooldown, function()
			blockCooldown = false
		end)
		blockStartTrack:Play()
		--blockStartTrack.Stopped:wait()
		blockBool.Value = true
		isClientBlocking = true
		blockIdleTrack:Play()
		blockIdleTrack.Looped = true
	--Stop Blocking
	elseif status == false and not isRunning and not isSlashing and isClientBlocking and not isEquiping and isEquipped and blockBool.Value == true and not specialOngoing  then
		task.delay(0.2, function()
			blockStartTrack:Stop()
			blockIdleTrack:Stop()
			blockEndTrack:Play()
			--blockEndTrack.Stopped:wait()
			blockBool.Value = false
			isClientBlocking = false
		end)
	end
end)



--Special
local specialAnim = script.Animations:WaitForChild("special")
local specialTrack = humanoid:LoadAnimation(specialAnim)
specialRemote.OnServerEvent:Connect(function(player)
	if not isRunning and not isSlashing and not isEquiping and isEquipped and not isClientBlocking and not specialCooldown then
		local character = player.Character
		local humanoid = character:WaitForChild("Humanoid")
		if not character or not humanoid then return end
		local hrp = character:WaitForChild("HumanoidRootPart")
		if not hrp then return end
		local sword = ClassicSword.SwordMesh
		if not sword then return end
		local rightArm = player.Character:WaitForChild("Right Arm")
		if not rightArm then print("Couldn't find right arm") return end

		local motor = rightArm:FindFirstChildWhichIsA("Motor6D")
		if motor then
			motor.C0 = motor.C0 * CFrame.new(0,0,-2.5) * CFrame.Angles(math.rad(180), 0, 0)
		end
		specialTrack:Play()
		specialCooldown = true
		task.delay(Config.SpecialCooldown, function()
			specialCooldown = false
		end)
		specialOngoing = true
		task.delay(1.5, function()--Damaging and creating the part and stuff
			specialTrack:Stop()
			player.DevEnableMouseLock = true
			hrp.Anchored = false
			specialOngoing = false
			motor.C0 = motor.C0 * CFrame.new(0,0,-2.5) * CFrame.Angles(math.rad(180), 0, 0)

			local part = Instance.new("Part")
			part.Name = "SpecialHitBox"
			part.Size = Vector3.new(33, 15, 36)
			part.Transparency = 0.7
			part.CastShadow = false
			part.CanCollide = false
			part.Color = Color3.new(1, 0, 0.0156863)
			part.Anchored = false
			part.Position = hrp.Position + hrp.CFrame.LookVector * 30
			part.Parent = script.Parent.Parent

			local speed = 50
			local direction = hrp.CFrame.LookVector.Unit
			-- BodyVelocity to move the part forward
			local bv = Instance.new("BodyVelocity")
			bv.MaxForce = Vector3.new(1e6, 1e6, 1e6)
			bv.Velocity = direction * speed
			bv.Parent = part

			-- BodyForce to counter gravity
			local bf = Instance.new("BodyForce")
			bf.Force = Vector3.new(0, workspace.Gravity * part:GetMass(), 0)
			bf.Parent = part
			
			--Damaging
			part.Touched:Connect(function(hit)
				if hit.Parent:FindFirstChild("Humanoid") then
					local char = hit.Parent
					local targetPlayer = Players:GetPlayerFromCharacter(char)
					if targetPlayer and char then
						local targetHumanoid = char:FindFirstChild("Humanoid")
						if targetHumanoid and targetHumanoid.Health > 0 then
							targetHumanoid:TakeDamage(Config.SpecialDamage)
						end
					elseif char then
						local targetHumanoid = char:FindFirstChild("Humanoid")
						if targetHumanoid and targetHumanoid.Health > 0 then
							targetHumanoid:TakeDamage(Config.SpecialDamage)
						end
					end
				end
			end)
			task.delay(2, function()
				part:Destroy()
			end)
		end)
		player.DevEnableMouseLock = false
		hrp.Anchored = true
	end
end)
